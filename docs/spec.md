# MacServerMonitor Spec (macOS only)

## Platform
- This project runs on **macOS only**.
- Target: macOS 13+ (SwiftUI + modern APIs)
- No Windows/Linux support.

## Goal
A lightweight monitoring dashboard for a macOS device used as a long-running server.
Focus on: Memory, CPU, Disk usage (%), Network connectivity.
Provide configurable threshold-based sound alerts.
Provide LAN read-only monitoring via HTTP.

## Non-Goals
- No privileged permissions (no admin, no accessibility, no full disk access)
- No background daemon/helper
- No temperature/fan/GPU metrics in v1
- No remote control (read-only)
- No long-term history persistence in v1 (only short in-memory series)

## UI
- A window-based dashboard (suitable for dedicated external display)
- A settings view
- Alert states must be visually obvious (e.g., red highlight / warning badge)

## Refresh / Sampling
- Configurable refresh interval: {5, 10, 30} seconds
- Default: 5 seconds
- Sampling interval == refresh interval in v1
- Remote requests must NOT increase sampling frequency (remote reads cached values)

## Metrics (Definitions)
### Memory
- Show:
  - total_bytes
  - used_bytes
  - free_bytes (or available_bytes if more accurate)
  - compressed_bytes (if available)
  - swap_used_bytes (if available)
- Also compute:
  - used_percent = used_bytes / total_bytes * 100

### CPU
- Show:
  - cpu_usage_percent (0-100)
  - load_avg_1, load_avg_5, load_avg_15

### Disk
- Show:
  - disk_used_percent (0-100) for system volume (root "/")
- v1 does not need per-volume breakdown.

### Network
- Show:
  - network_status: "normal" | "down"
  - last_ok_timestamp
- Connectivity check:
  - Try reachability to a target (configurable).
  - Default target: "gateway" if detectable, otherwise user-defined host.
  - Consider "down" after 2 consecutive failures.

## Alerts
### Alert Types
- memory
- cpu
- disk
- network

### Thresholds (configurable in Settings)
- memory_used_percent_threshold (default 85)
- cpu_used_percent_threshold (default 90)
- disk_used_percent_threshold (default 90)
- network_down_enabled (default true)

### Continuous Violation Rule
- cpu/memory/disk:
  - trigger if value > threshold for N consecutive samples
  - default N = 2
- network:
  - trigger if network_status == down (after 2 consecutive failures)

### Alert Throttling (Q8=C)
- On first trigger: play system sound once immediately
- If still in alerting state: repeat sound every X minutes
- Default X = 3 minutes
- When recovered: no sound (v1)

### Alert State Model
- normal
- alerting(since_timestamp)
- throttled(next_allowed_timestamp)

## Settings
All settings stored locally (UserDefaults in v1).
Required keys (name / type / default / allowed values):
- refresh_interval_seconds / Int / 5 / {5,10,30}
- memory_threshold_percent / Double / 85 / 0-100
- cpu_threshold_percent / Double / 90 / 0-100
- disk_threshold_percent / Double / 90 / 0-100
- consecutive_samples_to_trigger / Int / 2 / 1-10
- alert_repeat_minutes / Int / 3 / 1-60
- network_probe_target / String / "gateway" / {"gateway" or hostname/ip}
- http_server_enabled / Bool / true / {true,false}
- http_server_port / Int / 17890 / 1024-65535
- http_server_token / String / autogenerated / non-empty

## Remote Monitoring (LAN)
- HTTP server provides read-only access.
- Token required: "Authorization: Bearer <token>"
- Endpoints: see docs/api.md

## Acceptance Criteria (v1)
- Dashboard shows Memory/CPU/Disk/Network metrics and updates at configured interval.
- Changing settings takes effect without app restart.
- Alert sound triggers correctly with throttling and stops when recovered.
- HTTP API returns status/series and matches schema in docs/api.md.
- Runs on macOS only. No platform-specific branching for other OS.

